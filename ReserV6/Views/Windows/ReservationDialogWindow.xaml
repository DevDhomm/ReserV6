<Window
  x:Class="ReserV6.Views.Windows.ReservationDialogWindow"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
  Title="Reserver une salle"
  Width="600"
  Height="700"
  WindowStartupLocation="CenterOwner"
  Background="{DynamicResource ApplicationBackgroundBrush}"
  Foreground="{DynamicResource TextFillColorPrimaryBrush}"
  ResizeMode="CanResize"
  Loaded="Window_Loaded"
>
  <Border Padding="20">
    <Grid>
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" />
        <RowDefinition Height="Auto" />
      </Grid.RowDefinitions>

      <!-- Title -->
      <TextBlock
        Grid.Row="0"
        FontSize="20"
        FontWeight="Bold"
        Text="Formulaire de Reservation"
        Margin="0,0,0,16"
        />

      <!-- Room Info Section -->
      <Border
        Grid.Row="1"
        Background="{DynamicResource ControlAltFillColorSecondaryBrush}"
        Padding="12"
        CornerRadius="4"
        Margin="0,0,0,16"
        >
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
          </Grid.ColumnDefinitions>

          <StackPanel Grid.Column="0" Orientation="Vertical" Margin="0,0,12,0">
            <TextBlock FontWeight="Bold" Text="Salle selectionnee:" Margin="0,0,0,4" />
            <TextBlock FontSize="16" FontWeight="Bold" Text="{Binding ViewModel.SelectedSalle.Nom}" />
          </StackPanel>

          <StackPanel Grid.Column="1" Orientation="Vertical">
            <TextBlock FontWeight="Bold" Text="Informations" Margin="0,0,0,4" />
            <TextBlock Text="{Binding ViewModel.SelectedSalle.Description}" TextWrapping="Wrap" />
            <TextBlock Margin="0,4,0,0" Text="{Binding ViewModel.SelectedSalle.Capacite, StringFormat='Capacite: {0} personnes'}" />
            <TextBlock Text="{Binding ViewModel.SelectedSalle.Etage, StringFormat='Etage: {0}'}" />
          </StackPanel>
        </Grid>
      </Border>

      <!-- Motif Section -->
      <StackPanel Grid.Row="2" Orientation="Vertical" Margin="0,0,0,16">
        <TextBlock FontWeight="Bold" Text="Motif de la reservation:" Margin="0,0,0,4" />
        <TextBox
          x:Name="MotifTextBox"
          Text="{Binding ViewModel.Motif, UpdateSourceTrigger=PropertyChanged}"
          Padding="8,6"
          Height="60"
          TextWrapping="Wrap"
          VerticalScrollBarVisibility="Auto"
          AcceptsReturn="True"
          TextChanged="MotifTextBox_TextChanged"
          />
      </StackPanel>

      <!-- Date & Time Selection Section -->
      <Border
        Grid.Row="3"
        Background="{DynamicResource ControlAltFillColorSecondaryBrush}"
        Padding="12"
        CornerRadius="4"
        Margin="0,0,0,12"
        >
        <StackPanel Orientation="Vertical">
          <!-- Date Selection -->
          <StackPanel Orientation="Vertical" Margin="0,0,0,12">
            <TextBlock FontWeight="Bold" Text="Selectionnez une date:" Margin="0,0,0,8" />
            <DatePicker
              x:Name="DatePicker"
              SelectedDate="{Binding ViewModel.SelectedDate, UpdateSourceTrigger=PropertyChanged}"
              SelectedDateChanged="DatePicker_SelectedDateChanged"
              Padding="8,6"
              Height="36"
              />
            <TextBlock 
              Foreground="{DynamicResource TextFillColorTertiaryBrush}"
              Text="(Toutes les dates futures sont disponibles)"
              FontSize="11"
              Margin="0,4,0,0"
              />
          </StackPanel>

          <!-- Time Selection Option -->
          <CheckBox
            IsChecked="{Binding ViewModel.UseCustomTime, UpdateSourceTrigger=PropertyChanged}"
            Content="Utiliser des horaires personnalisés"
            Padding="0,8"
            Margin="0,8,0,12"
            />

          <!-- Custom Time Controls -->
          <StackPanel Visibility="{Binding ViewModel.UseCustomTime, Converter={StaticResource BoolToVisibilityConverter}}">
            <!-- Start Date -->
            <StackPanel Orientation="Vertical" Margin="0,0,0,12">
              <TextBlock FontWeight="Bold" Text="Date de début:" Margin="0,0,0,4" />
              <DatePicker
                SelectedDate="{Binding ViewModel.CustomStartDate, UpdateSourceTrigger=PropertyChanged}"
                SelectedDateChanged="CustomTimeChanged"
                Padding="8,6"
                Height="36"
                />
            </StackPanel>

            <!-- Start Time -->
            <StackPanel Orientation="Vertical" Margin="0,0,0,12">
              <TextBlock FontWeight="Bold" Text="Heure de début:" Margin="0,0,0,4" />
              <StackPanel Orientation="Horizontal">
                <TextBlock Text="De " Margin="0,0,4,0" VerticalAlignment="Center" />
                <TextBox
                  x:Name="StartTimeTextBox"
                  Text="{Binding ViewModel.CustomStartTime, StringFormat=hh\\:mm, UpdateSourceTrigger=PropertyChanged}"
                  Width="60"
                  Padding="6"
                  VerticalAlignment="Center"
                  Margin="0,0,4,0"
                  TextChanged="CustomTimeChanged"
                  />
                <TextBlock Text="(HH:mm)" Margin="0,0,0,0" VerticalAlignment="Center" Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
              </StackPanel>
            </StackPanel>

            <!-- End Date -->
            <StackPanel Orientation="Vertical" Margin="0,0,0,12">
              <TextBlock FontWeight="Bold" Text="Date de fin:" Margin="0,0,0,4" />
              <DatePicker
                SelectedDate="{Binding ViewModel.CustomEndDate, UpdateSourceTrigger=PropertyChanged}"
                SelectedDateChanged="CustomTimeChanged"
                Padding="8,6"
                Height="36"
                />
            </StackPanel>

            <!-- End Time -->
            <StackPanel Orientation="Vertical">
              <TextBlock FontWeight="Bold" Text="Heure de fin:" Margin="0,0,0,4" />
              <StackPanel Orientation="Horizontal">
                <TextBlock Text="À " Margin="0,0,4,0" VerticalAlignment="Center" />
                <TextBox
                  x:Name="EndTimeTextBox"
                  Text="{Binding ViewModel.CustomEndTime, StringFormat=hh\\:mm, UpdateSourceTrigger=PropertyChanged}"
                  Width="60"
                  Padding="6"
                  VerticalAlignment="Center"
                  Margin="0,0,4,0"
                  TextChanged="CustomTimeChanged"
                  />
                <TextBlock Text="(HH:mm)" Margin="0,0,0,0" VerticalAlignment="Center" Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
              </StackPanel>
            </StackPanel>
          </StackPanel>

          <!-- Predefined Creneaux Info -->
          <TextBlock
            Visibility="{Binding ViewModel.UseCustomTime, Converter={StaticResource InverseBoolToVisibilityConverter}, FallbackValue=Visible}"
            Foreground="{DynamicResource TextFillColorSecondaryBrush}"
            Text="{Binding ViewModel.CreneauxForSelectedDate.Count, StringFormat='Créneaux disponibles: {0}'}"
            FontSize="11"
            Margin="0,8,0,0"
            />
        </StackPanel>
      </Border>

      <!-- Creneaux List -->
      <ScrollViewer Grid.Row="5" VerticalScrollBarVisibility="Auto" Margin="0,0,0,16">
        <StackPanel>
          <!-- Conflict Warning Message -->
          <Border
            Background="#FFEBEE"
            BorderBrush="#F44336"
            BorderThickness="1"
            CornerRadius="4"
            Padding="12"
            Margin="0,0,0,12"
            Visibility="{Binding ViewModel.HasConflictWarning, Converter={StaticResource BoolToVisibilityConverter}}"
            >
            <StackPanel Orientation="Horizontal">
              <TextBlock
                Text="⚠️"
                FontSize="16"
                Margin="0,0,8,0"
                VerticalAlignment="Center"
                />
              <TextBlock
                Text="{Binding ViewModel.ConflictMessage}"
                TextWrapping="Wrap"
                VerticalAlignment="Center"
                Foreground="#C62828"
                FontWeight="SemiBold"
                />
            </StackPanel>
          </Border>

          <ItemsControl ItemsSource="{Binding ViewModel.CreneauxForSelectedDate}" Visibility="{Binding ViewModel.UseCustomTime, Converter={StaticResource InverseBoolToVisibilityConverter}, FallbackValue=Visible}">
          <ItemsControl.ItemTemplate>
            <DataTemplate>
              <Border
                Padding="12"
                Margin="0,0,0,8"
                Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="4"
                >
                <Grid>
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                  </Grid.ColumnDefinitions>

                  <!-- Creneau Info -->
                  <StackPanel Grid.Column="0" Orientation="Vertical" Margin="0,0,12,0">
                    <TextBlock
                      FontWeight="Bold"
                      Text="{Binding Debut, StringFormat='De {0:HH:mm}'}"
                      Margin="0,0,0,4"
                      />
                    <TextBlock
                      Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                      Text="{Binding Fin, StringFormat='A {0:HH:mm}'}"
                      Margin="0,0,0,4"
                      />
                    <TextBlock
                      Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                      Text="{Binding Duree, StringFormat='Duree: {0} heure(s)'}"
                      Margin="0,0,0,2"
                      />
                    <TextBlock
                      Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                      Text="Disponible"
                      />
                  </StackPanel>

                  <!-- Select Button -->
                  <ui:Button
                    Grid.Column="1"
                    Content="Selectionner"
                    Command="{Binding DataContext.ViewModel.SelectCreneauCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                    CommandParameter="{Binding}"
                    Padding="12,6"
                    VerticalAlignment="Center"
                    />
                </Grid>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
        </StackPanel>
      </ScrollViewer>

      <!-- Buttons -->
      <StackPanel Grid.Row="6" Orientation="Horizontal" HorizontalAlignment="Right">
        <ui:Button
          Content="Annuler"
          Click="OnCancelClick"
          Padding="20,8"
          Margin="0,0,8,0"
          />
        <ui:Button
          Content="Confirmer la reservation"
          Command="{Binding ViewModel.CreateReservationCommand}"
          Padding="20,8"
          IsEnabled="{Binding ViewModel.CanCreateReservation}"
          />
      </StackPanel>
    </Grid>
  </Border>
</Window>
